#!/bin/bash -e
# bin/compile <build-dir> <cache-dir>

# Exit if any subcommand fails
set -e
set -o pipefail

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
CURRENT_DIR=$PWD

TRANSCRYPT_ENV_FILE="$ENV_DIR/TRANSCRYPT_CMD"

if [ ! -f $TRANSCRYPT_ENV_FILE ]; then
    printf "\n-----> ERROR: Please set TRANSCRYPT_CMD. You can get the command by running in your project directory: transcrypt --display \n\n"
    exit 1
fi

TRANSCRYPT_CMD=$(cat $TRANSCRYPT_ENV_FILE)

printf "\n-----> Successfully retrieved TRANSCRYPT_CMD from ENV var"

mkdir -p $CACHE_DIR
cd $CACHE_DIR
if [ -d "transcrypt" ]; then
    cd transcrypt
    git fetch --quiet
    git pull --quiet
else
    git clone --quiet https://github.com/elasticdog/transcrypt.git
fi

cd $BUILD_DIR

# It doesn't have git, so initialize
printf "\n-----> Setting up git repo for transcrypt\n\n"
git init . --quiet

# Install transcrypt, its helper utils, and password/cipher
printf "\n-----> Installing and configuring transcrypt\n\n"
# Seems like it is not using the right cipher? Or maybe the salt is wrong??
# Check into the salts
$CACHE_DIR/transcrypt/$TRANSCRYPT_CMD -y

cat .gitattributes | \
grep "filter=crypt diff=crypt" | \
grep -v "^#" | \
sed 's/filter=crypt diff=crypt//;s/ //g' | \
tr '\n' '\0' | \
xargs -0 -I {} find . -name {} | \
while read file; do
    echo $file
    .git/crypt/smudge $file
    # .git/crypt/smudge $file > $file.dec && mv $file.dec $file
done

printf "\n-----> ls-crypt\n\n"
git ls-crypt

printf "\n-----> Did it encrypt?\n\n"
# cat config/slack.enc.cr
# cat config/google_oauth.enc.cr

printf "\n-----> All transcrypted files decrypted!\n\n"
